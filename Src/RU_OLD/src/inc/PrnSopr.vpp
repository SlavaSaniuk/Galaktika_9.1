!
!╔═══════════════════════════════════════════════════════════════════════════╗
!║ Назначение    : Печать расходной накладной                                ║
!╚═══════════════════════════════════════════════════════════════════════════╝
!

//******************************************************************************
// печать пустых полей
procedure WriteNullCount(counti: integer);
{
  if (Counti < 1)
    Exit;
  var k : integer;
  for (k := 1; k <= counti; k := k+1)
    Form_Write(0.0, Cena_Pr, frmHandle);
}

//******************************************************************************
// печать реквизитов организаций
#INCLUDE prn_org.vpp
#include prn_onkl.vpp



function GetTypeParentDoc : word;
{
  if MyDef.RzNakl
  {
    if GetFirst fastfirstrow SpSopr where ((KatSopr.Nrec == SpSopr.cSopr)) = tsOk
      if GetFirst fastfirstrow RzSpDoc where ((SpSopr.cOwner == RzSpDoc.NRec)) = tsOk
        if GetFirst fastfirstrow RzDoc where ((RzSpDoc.cSopr == RzDoc.NRec)) = tsOk
          GetTypeParentDoc := RzDoc.TypeMove;
  }
  else
    GetTypeParentDoc := TypeSopr;
}

//******************************************************************************
// печать внешних атрибутов
procedure WriteExtAttr(tTbl:word;tNRec:comp;tKol:byte);
{
  if (tNRec = 0)
  {
    Form_SkipFormat(tKol, frmHandle);
    Exit;
  }

  if (GetFirst AttrVal where (( tTbl   == AttrVal.wTable and
                                tNrec  == AttrVal.cRec )) <> tsOk)
  {
    Form_SkipFormat(tKol, frmHandle);
    exit;
  }

  _Loop AttrNam where ((tTbl == AttrNam.wTable))
        ordered by index AttrNam1
  {
    if (GetFirst AttrVal where ((
                                  tTbl         == AttrVal.wTable   and
                                  tNrec        == AttrVal.cRec     and
                                  AttrNam.NRec == Attrval.cAttrNam      )) = tsOk)
    {
      case AttrNam.AttrType of
        0 : Form_Write(AttrVal.vString, '', frmHandle);
        1 : Form_Write(DoubleToStr(AttrVal.vDouble,'66666666666666.88888'), '', frmHandle);
        2 : Form_Write(string(AttrVal.vDate), '', frmHandle);
        3 : Form_Write(string(AttrVal.vTime), '', frmHandle);
      else Form_Write(AttrVal.vString, '', frmHandle);
      end
    }
    else
      Form_SkipFormat(1, frmHandle);

    tKol := tKol - 1;
    if (tKol = 0) break;
  }

  Form_SkipFormat(tKol, frmHandle);
}


//******************************************************************************
// Суммарное значение для нескольких значений по одному внешнему классификатору
Function SumClassSegName(wTable: word; cRec: comp; aClass: string): string;
{
  SumClassSegName := '';

  if GetFirst ExClassName where (( wTable   ==  ExClassName.wTable  and
                                   aClass   ==  ExClassName.Name        )) = tsOk
  {
    var s: string;
    s := '';

    _Loop ExClassVal
       where (( cRec                  ==  ExClassVal.cRec  and
                ExClassName.ClassCode ==  ExClassVal.ClassCode ))
       ordered by index ExClassVal04

      if GetFirst ExClassSeg where (( ExClassVal.cClassSeg  == ExClassSeg.NRec )) = tsOk
      {
        if (s <> '') s := s + '; ';
        s := s + ExClassSeg.Name;
      }

    SumClassSegName := s;
  }//end if
}


//******************************************************************************
// печать 10 первых tKol значений до 2-го уровня иерархии
// классификатора aClass из таблицы wTable
// для записи cRec
procedure WriteClassNode (wTable,tKol: word; cRec: comp; aClass: string);
{
  if GetFirst ExClassName where (( wTable   ==  ExClassName.wTable  and
                                   aClass   ==  ExClassName.Name        )) = tsOk


  _LOOP ExClassVal
     where (( cRec                  ==  ExClassVal.cRec  and
              ExClassName.ClassCode ==  ExClassVal.ClassCode ))
      ordered by index ExClassVal04
  {
    IF (tKol <= byte(0)) break;

    if GetFirst ExClassSeg where (( ExClassVal.cClassSeg  == ExClassSeg.NRec )) = tsOk
      //по первой ветке
      if GetFirst ExClassSeg2 where (( ExClassSeg.ClassCode == ExClassSeg2.ClassCode and
                                       ExClassSeg.NRec      == ExClassSeg2.cGroup
                                    )) = tsOk
      {
        _Loop ExClassSeg2 where (( ExClassSeg.ClassCode == ExClassSeg2.ClassCode and
                                   ExClassSeg.NRec      == ExClassSeg2.cGroup
                                 ))

          if (tKol > byte(0))
          {
            Form_Write(ExClassSeg2.Name, '', frmHandle);
            tKol := tKol - 1;
          }
          else break;
      }
      //
      else
      {
        Form_Write(ExClassSeg.Name, '', frmHandle);
        tKol := tKol - 1;
      }
  }

  Form_SkipFormat(tKol, frmHandle);
}


//******************************************************************************
// печать Persons
procedure WriteAPost(tNRec: comp; wPrnFld: word);
var
  sPost, sFIO, sTabNum: string;
{
  sPost   := '';
  sFIO    := '';
  sTabNum := '';

  if (wPrnFld = 0)
    EXIT;

  if GetFirst fastfirstrow Persons where ((tNRec == Persons.NRec)) = tsOk
  {
    sFIO    := Persons.FIO;
    sTabNum := string(Persons.TabNmb);

    if GetFirst fastfirstrow Appointments where ((Persons.AppointCur == Appointments.Nrec)) = tsOk
      if GetFirst fastfirstrow Catalogs where ((Appointments.Post == Catalogs.Nrec)) = tsOk
        sPost := Catalogs.Name;

  }

  if ((wPrnFld AND 1) = 1)
    Form_Write(sFIO, '', frmHandle);

  if ((wPrnFld AND 2) = 2)
    Form_Write(sTabNum, '', frmHandle);

  if ((wPrnFld AND 4) = 4)
    Form_Write(sPost, '', frmHandle);
}


//******************************************************************************
// печать доп.классификации по SpSopr и KatPaty
procedure WriteDopClassInfo(aClassName: string);
var
 s: string;
{
   s := WriteClass(coSpSopr,SpSopr.NRec,aClassName);
   if s <> ''
     Form_Write(s, '', frmHandle)
   else
   {
     s := WriteClass(coKatParty,KatParty.NRec,aClassName);
     if s <> ''
       Form_Write(s, '', frmHandle)
     else
       Form_SkipFormat(1, frmHandle)
   }
}


//******************************************************************************
// Получить значение из одноименный внешней классификации и внешнего атрибута,
// с приоритетом для значения из классификации
function GetClassAttrValue (wTable: word; cRec: comp; aName: string): string;
var
  s: string;
{
  s := WriteClass(wTable, cRec, aName);
  GetClassAttrValue := if(s = '', WriteAttr(wTable, cRec, aName), s);
}


//******************************************************************************
// печать графы 16 (с грузом следуют документы) для текущей позиции SPSOPR
Procedure GetDocOfGoods(var sRes, sRes2, sRes3, sRes4: string);
{
  if (pClassDocOfGoods = comp(0))
    EXIT;

  RunInterface('Prn_DocOfGoods', pClassDocOfGoods, wClassCodeDocOfGoods, SpSopr.NRec, sRes, sRes2, sRes3, sRes4);
}


//******************************************************************************
// печать реквизитов организации и ее банка
procedure WriteOrg (aOrg: comp; isMyOrg: boolean);
{
  if (isMyOrg)
    PrintBankMyOrg(frmHandle, aOrg)
  else
    PrintBankOrg(frmHandle, aOrg);

  if (aOrg = comp(0))
    Form_SkipFormat(1, frmHandle)
  else
    Form_Write(oKatOrgAttr.GetJurAddr(aOrg), '', frmHandle);  // ..._ЮрАдрес
}


//******************************************************************************
// печать названия головной организации
procedure WriteHeadOrg (aOrg: comp);
var
  cHeadRec : comp;
{
  cHeadRec := oExtAttr.coGetAttr(coKatOrg, aOrg, 'Головная организация');

  if (GetFirst KatOrgF where (( cHeadRec == KatOrgF.NRec )) = tsOk)
    Form_Write(pKatorg.GetKatOrgName(cHeadRec, koOnTune), '', frmHandle);
  else
    Form_SkipFormat(1, frmHandle);
}


//******************************************************************************
// процедура печати позиций МЦ
#include prnrasmc.vpp
// процедура печати услуг
#include prnrasus.vpp


//******************************************************************************
// печать документа
Procedure PrintDocument;
var
  visstarted           : boolean;     

  pg_flag              : word;

  pickrec              : comp;

  MarkerCount, i, iNakl: longint; // счетчики записей в маркере
  TaraVoz              : string;

  FixGrMCCode          : string; 

{
  FixGrMCCode     := String(coGetTune('PICK.CGRMCF'));

   if (not isSklDoc)
     if (KatSopr.cOrgBase = 0)
     {
       message('Документ не оформлен. Печать прервана.');
       Exit;
     }

  TaraVoz  := '';
  pg_flag  := 0;

  iAllDocs := 1;
  iCerts   := 1;

  for (i := 1; i <= 5; i++)
  {
    sCerts[i]     := '';
    sAllDocs[i]   := '';
  }

  sPrice := '';

  MarkerCount := GetMarkerCount(MarkerNZ);

  if (MarkerCount = 0)
  {
    pickrec := KatSopr.NRec;
    MarkerCount:=1;
  }
  else
    if ((wParam AND 4) <> 4)
      if (RunDialog('PrintBaseDocParams', pg_flag) = cmCancel)
        exit;

  //установка группы
  Form_SetGroup(sGroupName, frmHandle);

  if MyDef.doc201byte1
  {
    var _ret: word;

    if GetVipRef (bPrint, 'ArtDiz1')
    {
      _ret:= bPrint.QueryGroup(KatSopr.nrec);
      case _ret of
       -1:
         {
           FreeVIPInterface (bPrint);
           MyDef.doc201byte1:= false;
           exit;
         }
        0: Form_SetGroup('Группировка по обобщенному наименованию', frmHandle);
        1: Form_SetGroup('Группировка по внешнему артикулу', frmHandle);
        2: Form_SetGroup('Группировка по дополнительному штрих-коду', frmHandle);
      end;
    }
    else
    {
       message('Не загрузился интерфейс objArtDiz1.'#10#13 +
               'Печать отменена',mfError);
       MyDef.doc201byte1:= false;
       exit;
    }

  }

  if (Form_Error(frmHandle))
  {
    Form_AbortForm(frmHandle);
    Exit;
  }

!-----------------------------------------------------------------------------------------------------------------
  // В Ы В О Д   Ш А П К И  Н А К Л А Д Н О Й
!-----------------------------------------------------------------------------------------------------------------

  StartNewVisual(vtRotateVisual, vfTimer+vfBreak+vfConfirm,
    ''#3'Печать накладной ...',1);

FOR ( iNakl := 0; iNakl < MarkerCount; iNakl++ )    // цикл по всем накладным
{
  if (GetMarkerCount(MarkerNZ) <> 0)
    GetMarker(MarkerNZ, iNakl, pickrec);

  if (GetFirst KatSopr where ((pickrec == KatSopr.NRec)) <> tsOk)
    continue;

  ReStartVisual(''#3'Печать накладной '+PrintNumber(KatSopr.Descr,KatSopr.NSopr),1);

  // выбор вариантов наименования МЦ Услуг
  if (isPrnVariantMcUsl)
    RunInterFace(PrnVariatMcUsl, KatSopr.NRec, 0);

  //прерывание по кнопке
  if (Form_Error(frmHandle))
  {
    StopVisual('',0);
    Form_PutEvent(feBreak, frmHandle);
    Form_AbortForm(frmHandle);
    Exit;
  }

  VisStarted := true;

  //курс валюты
  if (KatSopr.dPrice = ZeroDate)
  {
    CursV := 1;

    // если не указана дата курса - брать курс на дату документа
    if (KatSopr.cValut <> 0)
      oValFunc.GetCurse(KatSopr.cValut, KatSopr.dSopr, CursV)
  }
  else
    CursV := GetCursPrice;

  //входимость НДС в цену
  NdsInPrice := false;
  case KatPodr.UchPrc of
    0: NdsInPrice := boolean(wGetTune('Oper.FormUch'));
    1: NdsInPrice := true;
  end;//case
                                                                                  //  ПОЛЯ ИЗ TOVN
!-----------------------------------------------------------------------------------------------------------------
  Form_Write(KatSopr.nRec, '', frmHandle);                                                 //  накладная_нрек
  Form_Write(if (wGetTune('Country')=1,' УНН ',' ИНН '), '', frmHandle);                   //  unn_inn
!-----------------------------------------------------------------------------------------------------------------
  // кол-во товарных позиций
  var Kol_SpSopr : word;
  Kol_SpSopr := 0;
  bNalProd  := FALSE;
  bFixGrMC  := FALSE;
  //список групп МЦ с фиксированными ценами

  FixGroupMC.AllowedDepGroupList := InitMarker('getgrfmc_mark', 8, 10, 5);
  FixGroupMC._LOOP KatLink

  if (FixGroupMC.KatLink.cRec <> 0)
    InsertMarker(FixGroupMC.AllowedDepGroupList, FixGroupMC.KatLink.cRec);

  bNalProd := GetFirst SpDocNalF where (( KatSopr.NRec     ==  SpDocNalF.cDoc    and
                                          KatSopr.VidSopr  ==  SpDocNalF.TipDoc  and
                                          cNalogProd       ==  SpDocNalF.cNalog )) = tsOk;

  _Loop SpSopr
  {
    inc(Kol_SpSopr);

    if (NOT bFixGrMC)
      if (KatMC.cGroupMC <> 0) AND (FixGrMCCode <> '')
        bFixGrMC := SearchMarker(FixGroupMC.AllowedDepGroupList, KatMC.cGroupMC, 0);
  }

  DoneMarker(FixGroupMC.AllowedDepGroupList, 'getgrfmc_mark');

  Form_Write(Kol_SpSopr, '', frmHandle);                                                   //  количество_SpSopr

  bAutoGrM := if (isSklDoc, boGetTune('SKLAD.CALCGRM'), boGetTune('OPER.SELL.NAKL.CALCGRM'));

  Form_Write(bNalProd, '', frmHandle);
  Form_Write(bFixGrMC, '', frmHandle);
  Form_Write(bAutoGrM, '', frmHandle);
!-----------------------------------------------------------------------------------------------------------------
  Form_Write(GetTypeParentDoc, '', frmHandle);                                             //  тип_родительского_документа

  // Если есть классификация ЛИЦЕНЗИЯ, то печетать ее
  Form_Write (GetClassAttrValue (coKatOrg, cMyOrg,            'ЛИЦЕНЗИЯ'), '', frmHandle); // Лицензия_Поставщик
  Form_Write (GetClassAttrValue (coKatOrg, KatSopr.cGruzFrom, 'ЛИЦЕНЗИЯ'), '', frmHandle); // Лицензия_Грузоотправитель
  Form_Write (GetClassAttrValue (coKatOrg, KatSopr.cGruzTo,   'ЛИЦЕНЗИЯ'), '', frmHandle); // Лицензия_Грузополучатель
  Form_Write (GetClassAttrValue (coKatOrg, KatSopr.cOrgBase,  'ЛИЦЕНЗИЯ'), '', frmHandle); // Лицензия_Получатель
  Form_Write (GetClassAttrValue (coKatOrg, KatSopr.cOrgBase,  'ЛИЦЕНЗИЯ'), '', frmHandle); // Лицензия_Плательщик
  Form_Write (GetClassAttrValue (coKatOrg, KatSopr.cOrgPlat,  'ЛИЦЕНЗИЯ'), '', frmHandle); // Лицензия_Заказчик_Плательщик
!-----------------------------------------------------------------------------------------------------------------
  if (MyDef.RzNakl)
    Form_Write(SumClassSegName(corzDoc, KatSopr.cADoc, 'ПРЕЙСКУРАНТ'), '', frmHandle);     // ПрейскурантЦен
  else
    Form_Write(SumClassSegName(coKatSopr, KatSopr.NRec, 'ПРЕЙСКУРАНТ'), '', frmHandle);     // ПрейскурантЦен
!-----------------------------------------------------------------------------------------------------------------
  var cBuh : comp;
  cBuh := coGetTune('Doc.SD.PrnNakl.StBuh');
  cBuh := if (cBuh = comp(0), coGetTune('MainBuh'), cBuh);
  Form_Write(if(sGetTune('Boss')    = '', '', '(' + sGetTune('Boss')    + ')'), '', frmHandle); // Директор
  WriteAPost(coGetTune('Boss'), 2 + 4);
  Form_Write(if(sBuhName = '', '', '(' + sBuhName + ')'), '', frmHandle);                       // Главный_Бухгалтер
  WriteAPost(cBuh, 2 + 4);
!-----------------------------------------------------------------------------------------------------------------
  // данные о поставщике (реквизиты, адрес, банковские реквизиты)
  if ((TypeSopr = 106) or isPrihNakl)                                             // Поставщик
    WriteOrg (KatSopr.cOrgBase, false);
  else
    WriteOrg (cMyOrg, true);
!-----------------------------------------------------------------------------------------------------------------
  // признак расчета налогов
  isNalogs   := true;

  if (NOT MyDef.RzNakl)
    case KatSopr.VidSopr of
      600..607:
      {
        PushPos(#KatState);
        if GetFirst KatState where ((MyKatOrg.cState == KatState.NRec)) = tsOk
          isNalogs := (KatState.isNal = 1);
        PopPos(#KatState);
      }
      else
      {
        if isValid(#KatState)
          isNalogs := (KatState.isNal = 1);
      }
    end;
!-----------------------------------------------------------------------------------------------------------------
  Form_Write(KatSopr.NSopr, '', frmHandle);                                                // Номер
  Form_Write(KatSopr.Descr, '', frmHandle);                                                // ОператорЭВМ
  Form_Write(PrintNumber(KatSopr.Descr,KatSopr.NSopr), '', frmHandle);                     // Номер_с_дескриптором
  Form_Write(KatSopr.UserField, '', frmHandle);                                            // ПолеПользователя

  if (GetFirst Dogovor where ((KatSopr.cDogovor == Dogovor.nRec)) = tsOk)
  {
    Form_Write(if(wGetTune('Dog.DogNameInDoAndSoprDoc') = 0, Dogovor.NoDoc                 // Номер_Договора
                                                           , Dogovor.NoDoc_Ext), '', frmHandle);
    Form_Write(if(wGetTune('Dog.DateDogInDoAndSoprDoc') = 0, Dogovor.dDoc                  // Дата_Договора
                                                           , Dogovor.dInput), '', frmHandle);                                             
    Form_Write(Dogovor.NoDoc_Ext, '', frmHandle);                                          // Номер_Договора_Ext
  }
  else
    Form_SkipFormat(3, frmHandle);

  Form_Write(KatSopr.dSopr, '', frmHandle);                                                // Дата
  Form_Write(day(KatSopr.dSopr), '', frmHandle);                                           // ДатаДень
  Form_Write(datetostr(KatSopr.dSopr,'mon'), '', frmHandle);                               // ДатаМесяц
  Form_Write(datetostr(KatSopr.dSopr,'YY'), '', frmHandle);                                // ДатаГод
!-----------------------------------------------------------------------------------------------------------------
  // данные о грузоотправителе (реквизиты, адрес, банковские реквизиты)
  if (cMyOrg = KatSopr.cGruzFrom)                                                 // Грузоотправитель
    //собственная организация
    WriteOrg (KatSopr.cGruzFrom, true);
  else
  {
    if (KatSopr.cGruzFrom <> 0) then
    {
      case TypeSopr of
        206: WriteOrg (KatSopr.cGruzFrom, true);
        106: WriteOrg (KatSopr.cGruzFrom, false);
      else
        WriteOrg (KatSopr.cGruzFrom, false);
      end;
    }
    else
    {
      case TypeSopr of
        206: WriteOrg (cMyOrg, true);
        106: WriteOrg (KatSopr.cOrgBase, false);
      else
        WriteOrg (KatSopr.cGruzFrom, false);
      end;
    }
  }

  WriteHeadOrg(KatSopr.cGruzFrom);                                                //Грузополучатель_Головная_Орг_Наимен

!-----------------------------------------------------------------------------------------------------------------
  // данные о грузополучателе (реквизиты, адрес, банковские реквизиты)
  if (cMyOrg = KatSopr.cGruzTo)                                                   // Грузополучатель
    // собственная организация
    WriteOrg (KatSopr.cGruzTo, true);
  else
  {
    if (KatSopr.cGruzTo <> 0) then
    {
      case TypeSopr of
        106: WriteOrg (KatSopr.cGruzTo, true);
        206: WriteOrg (KatSopr.cGruzTo, false);
      else
        WriteOrg (KatSopr.cGruzTo, false);
      end;
    }
    else
    {
      case TypeSopr of
        106: WriteOrg (cMyOrg, true);
        206: WriteOrg (KatSopr.cOrgBase, false);
      else
        WriteOrg (KatSopr.cGruzTo, false);
      end;
    }
  }

  WriteHeadOrg(KatSopr.cGruzTo);                                                  //Грузополучатель_Головная_Орг_Наимен

!-----------------------------------------------------------------------------------------------------------------
  // дата оприходования
  Form_Write(KatSopr.dOpr, '', frmHandle);                                                 // Дата_Отгрузки
!-----------------------------------------------------------------------------------------------------------------
  // информация из доверенности
  Form_Write(KatSopr.nDover, '', frmHandle);                                               // НомерДовер
  Form_Write(KatSopr.dDover, '', frmHandle);                                               // ДатаДовер
  Form_Write(KatSopr.sDover, '', frmHandle);                                               // ФИОДовер
  // информация из каталога доверенных лиц
  if (KatSopr.cDovFIO <> 0)
  {
    Form_Write(DovFIO.Name    , '', frmHandle);                                            // ДовЛицо
    Form_Write(DovFIO.Post    , '', frmHandle);                                            // ДовЛицоДолжность
    Form_Write(DovFIO.PasSer  , '', frmHandle);                                            // ДовЛицоПаспСерия
    Form_Write(DovFIO.PasNumb , '', frmHandle);                                            // ДовЛицоПаспНомер
    Form_Write(DovFIO.WhereVid, '', frmHandle);                                            // ДовЛицоПаспГде
    Form_Write(DovFIO.DatVid  , '', frmHandle);                                            // ДовЛицоПаспКогда
  }
  else
    Form_SkipFormat(6, frmHandle);

  // организация, выдавшая доверенность
  var sGruzPol: string;

  case TypeSopr of
    106: sGruzPol := MyKatOrg.Name;                                               // ОргДовер
    206: sGruzPol := KatOrg.Name;
  else
    sGruzPol := KatOrgTo.Name;
  end;

  if (KatSopr.TipSopr = 1)  // приход
    if (isValid(#Dover))
      if (Dover.Direct = 1)
        Form_Write(OrgDovPay.Name, '', frmHandle)
      else
        Form_Write(OrgDovPost.Name, '', frmHandle)
    else
      if (KatSopr.nDover = '')
        Form_SkipFormat(1, frmHandle)
      else
        Form_Write(sGruzPol, '', frmHandle)
  else
    if (isValid(#Dover))
      if (Dover.Direct = 1) OR (Dover.Direct = 3)
        Form_Write(OrgDovPay.Name, '', frmHandle)
      else
        Form_Write(OrgDovPost.Name, '', frmHandle)
    else
      if (KatSopr.nDover = '')
        Form_SkipFormat(1, frmHandle)
      else
        Form_Write(sGruzPol, '', frmHandle);
!-----------------------------------------------------------------------------------------------------------------
  // примечание                                                                   // Назван_накладной
  Form_Write(KatSopr.Name, '', frmHandle);
!-----------------------------------------------------------------------------------------------------------------
  // информация о складе, МОЛе
  if (MyDef.doc201byte1)
    Form_Write(KatPayment.Name + '.' + KatOrg.INDEXK, '', frmHandle);                      // Склад
  else
    Form_Write(KatPodr.Name, '', frmHandle);                                               // Склад

  Form_Write(KatPodr.Addr, '', frmHandle);                                                 // Склад_Адрес

  if ( KatSopr.Reserved = 2 ) and ( KatSopr.VidSopr = 115 )  // 106.9348
    {
      Form_Write(KatPodr.Name, '', frmHandle);                                             // Склад_Пол
      Form_Write(KatPodr.Addr, '', frmHandle);                                             // Склад_Пол_Адрес
    }
  else
    {
      Form_Write(KatPodrTo.Name, '', frmHandle);                                           // Склад_Пол
      Form_Write(KatPodrTo.Addr, '', frmHandle);                                           // Склад_Пол_Адрес
    }

  if (MyDef.doc201byte1)
    Form_Write(KatPodr.KOD     + '.' + KatMol.KOD, '', frmHandle);                         // МОЛ
  else
    Form_Write(KatMol.Name, '', frmHandle);                                                // МОЛ

  WriteAPost(KatMol.cPersons, 2 + 4);                                                      // МолДолжность
  Form_Write(KatPodr.FIO, '', frmHandle);                                                  // СкладРуководитель
  Form_Write(KatMolTo.Name, '', frmHandle);                                                // МОЛ_Пол
  WriteAPost(KatMolTo.cPersons, 2 + 4);                                                        // МолДолжность_Пол
  Form_Write(KatPodrTo.FIO, '', frmHandle);                                                // СкладРуководитель_Пол
!-----------------------------------------------------------------------------------------------------------------
  // Название ТХО
  var iTxoBind : TxoBinder;
  if ( GetFirst fastfirstrow SoprHoz where (( KatSopr.VidSopr == SoprHoz.TipDoc
                                          and KatSopr.NRec    == SoprHoz.cSoprDoc )) = tsOK )
    Form_Write(iTxoBind.ShowName(SoprHoz.BufferP), '', frmHandle)   // Название ТХО
  else
    Form_SkipFormat(1, frmHandle);
!-----------------------------------------------------------------------------------------------------------------
  // данные о получателе (реквизиты, адрес, банковские реквизиты)
  if (cMyOrg = KatSopr.cOrgBase)                                                  // Получатель
    // собственная организация
    WriteOrg (KatSopr.cOrgBase, true);
  else
    if ((TypeSopr = 106) or isPrihNakl)
      WriteOrg (cMyOrg, true);
    else
      WriteOrg (KatSopr.cOrgBase, false);
!-----------------------------------------------------------------------------------------------------------------
  // данные о плательщике (контрагенте взаиморасчетов)
  // (реквизиты, адрес, банковские реквизиты)
  if (cMyOrg = KatSopr.cOrg)                                                      // Плательщик
    //собственная организация
    WriteOrg (KatSopr.cOrg, true);
  else
  {
    //в рекламационных накладных - плательщик = грузополучатель
    case TypeSopr of
      106: WriteOrg (cMyOrg, true);
      206: WriteOrg (KatSopr.cOrgBase, false)
    else
      if (isPrihNakl)
        if (GetFirst Dogovor where ((KatSopr.cDogovor == Dogovor.nRec)) = tsOk)
          WriteOrg (Dogovor.cPlat, false);
        else
          if (GetFirst Dogovor where ((KatSopr.cAppDogovor == Dogovor.nRec)) = tsOk)
            WriteOrg (Dogovor.cPlat, false);
          else
            WriteOrg (cMyOrg, true);
      else
        WriteOrg (KatSopr.cOrg, false)
    end;
  }
!-----------------------------------------------------------------------------------------------------------------
  // данные о заказчике  (реквизиты, адрес, банковские реквизиты)
  if (cMyOrg = KatSopr.cOrgPlat)                                                  // Заказчик_Плательщик
    //собственная организация
    WriteOrg (KatSopr.cOrgPlat, true);
  else
  {
    if (isPrihNakl)
      WriteOrg (KatSopr.cOrgBase, false)
    else
      WriteOrg (KatSopr.cOrgPlat, false)
  }
!-----------------------------------------------------------------------------------------------------------------
  if (MyDef.RzNakl)
  {
    Form_Write(WriteClass(corzDoc, KatSopr.cADoc, 'ОСНОВАНИЕ ОТПУСКА'), '', frmHandle);                  // Основание_отпуска
    Form_Write(WriteClass(corzDoc, KatSopr.cADoc, 'ЦЕЛЬ ПРИОБРЕТЕНИЯ ПРОДУКЦИИ(ТОВАРА)'), '', frmHandle);// Цель_приобретения
  }
  else
  {
    Form_Write(WriteClass(coKatSopr, KatSopr.Nrec, 'ОСНОВАНИЕ ОТПУСКА'), '', frmHandle);                  // Основание_отпуска
    Form_Write(WriteClass(coKatSopr, KatSopr.Nrec, 'ЦЕЛЬ ПРИОБРЕТЕНИЯ ПРОДУКЦИИ(ТОВАРА)'), '', frmHandle);// Цель_приобретения
  }
!-----------------------------------------------------------------------------------------------------------------
  // счет-фактура
  Form_Write(SchFact.NRec, '', frmHandle);                                                 // СчФакт_НРек
  Form_Write(SchFact.Num, '', frmHandle);                                                  // СчФакт_Номер
!-----------------------------------------------------------------------------------------------------------------
  // Товарно-транспортная информация
  RunInterface ('PrnTTInfo', frmHandle, coKatSopr, KatSopr.NRec);

!-----------------------------------------------------------------------------------------------------------------
  // информация по ДО
  if (KatSopr.cStepDoc <> 0)
  {
    Form_PutEventById(feTrue, if (isDEI, fcTovN01_DEI, fcTovN01), frmHandle);
    Form_Write(BaseDoc.NoDoc, '', frmHandle);                                              // Основание
    Form_Write(BaseDoc.dDoc, '', frmHandle);                                               // ДатаОснования
  }
  else
    Form_PutEventById(feFalse, if (isDEI, fcTovN01_DEI, fcTovN01), frmHandle);
  // назначение
  if (isValid(#KatNazna))                                                         // Назначение
  {
    Form_PutEventById(feTrue, if (isDEI, fcTovN02_DEI, fcTovN02), frmHandle);
    Form_Write(KatNazna.Name, '', frmHandle);
  }
  else
    Form_PutEventById(feFalse, if (isDEI, fcTovN02_DEI, fcTovN02), frmHandle);
!-----------------------------------------------------------------------------------------------------------------
  // наряд-заказ
  Form_Write(NZakaz.NoDoc, '', frmHandle);                                                 // НарядЗаказНомер
  Form_Write(NZakaz.DDoc, '', frmHandle);                                                  // НарядЗаказДата
!-----------------------------------------------------------------------------------------------------------------
  //символы валют
  Form_Write(Valut, '', frmHandle);                                                               // НакСимвол
  Form_Write(oValFunc.GetValSymbol(0), '', frmHandle); // НацСимвол
  Form_Write(KlVal.SimvolV, '', frmHandle);                                                       // ВалСимвол
!-----------------------------------------------------------------------------------------------------------------
  //курс на дату списания
  ResOrder := GetFirst SklOrder where ((KatSopr.NRec == SklOrder.cSopr)) = tsOk;
  if (not ResOrder)
  {
    InitMCInfo(KatSopr.dSopr);
    SkladProizv(SkPr);
  }

  oValFunc.InitVal;

  if (ResOrder) and (KatSopr.cVal <> 0)
  {
    var kkk:double;
    if (oValFunc.GetCurse(KatSopr.cValut, SklOrder.dOrd, kkk))
      Form_Write(kkk, '', frmHandle);                                                      // Курс_списания
    else
      Form_Write('', '', frmHandle);
  }
  else
    Form_SkipFormat(1, frmHandle);
!-----------------------------------------------------------------------------------------------------------------
  // внешний атрибуты по накладной
  if (wGetTune('Doc.Sell.PrintAttr') <> 1)
    Form_SkipFormat(30, frmHandle);
  else
  {
    // атр1_нак атр2_нак атр3_нак атр4_нак атр5_нак атр6_нак атр7_нак атр8_нак атр9_нак атр10_нак
    WriteExtAttr(coKatSopr,KatSopr.NRec,10);
    // атр1_пол атр2_пол атр3_пол атр4_пол атр5_пол атр6_пол атр7_пол атр8_пол атр9_пол атр10_пол
    WriteExtAttr(coKatOrg,KatOrg.NRec,10);
    // атр1_тти атр2_тти атр3_тти атр4_тти атр5_тти атр6_тти атр7_тти атр8_тти атр9_тти атр10_тти
    if isValid(#TTNDoc)
      WriteExtAttr(coTTNDoc,TTNDoc.NRec,10)
    else
      Form_SkipFormat(10, frmHandle);
  }
!-----------------------------------------------------------------------------------------------------------------
  //внешние атрибуты в TNDoc
  if isValid(#TTNDoc)
  {
    var s1,s2:string;

    Form_Write(WriteAttr(coTTNDoc,TTNDoc.NRec,'СДАЛ ОТПРАВИТЕЛЬ ДОЛЖНОСТЬ') , '', frmHandle);// сдал_отправитель_должность
    Form_Write(WriteAttr(coTTNDoc,TTNDoc.NRec,'СДАЛ ОТПРАВИТЕЛЬ')           , '', frmHandle);// сдал_отправитель
    Form_Write(WriteAttr(coTTNDoc,TTNDoc.NRec,'ОТПУСК РАЗРЕШИЛ ДОЛЖНОСТЬ')  , '', frmHandle);// отпуск_разрешил_должность
    Form_Write(WriteAttr(coTTNDoc,TTNDoc.NRec,'ОТПУСК РАЗРЕШИЛ')            , '', frmHandle);// отпуск_разрешил
    Form_Write(WriteAttr(coTTNDoc,TTNDoc.NRec,'ОТПУСК РАЗРЕШИЛ ДОЛЖНОСТЬ 2'), '', frmHandle);// отпуск_разрешил_должность2
    Form_Write(WriteAttr(coTTNDoc,TTNDoc.NRec,'ОТПУСК РАЗРЕШИЛ 2')          , '', frmHandle);// отпуск_разрешил2
    Form_Write(WriteAttr(coTTNDoc,TTNDoc.NRec,'ОТПУСК РАЗРЕШИЛ ДОЛЖНОСТЬ 3'), '', frmHandle);// отпуск_разрешил_должность3
    Form_Write(WriteAttr(coTTNDoc,TTNDoc.NRec,'ОТПУСК РАЗРЕШИЛ 3')          , '', frmHandle);// отпуск_разрешил3
    //водитель
    s1 := WriteAttr(coTTNDoc,TTNDoc.NRec,'ВОДИТЕЛЬ');                               // водитель
    if (s1 = '')
     if GetFirst KnDriver where ((TTNDoc.cDriver == KnDriver.NRec)) = tsOk
       s1 := KnDriver.Name;
    Form_Write(s1, '', frmHandle);
    //экспедитор
    s2 := WriteAttr(coTTNDoc,TTNDoc.NRec,'ЭКСПЕДИТОР');
    if (s2 = '')
     if GetFirst KnDriver where ((TTNDoc.cDoc2 == KnDriver.NRec)) = tsOk
       s2 := KnDriver.Name;
    Form_Write(s2, '', frmHandle);                                                           // экспедитор
    //собственный транспорт
    Form_Write(WriteAttr(coTTNDoc,TTNDoc.NRec,'СОБСТВЕННЫЙ ТРАНСПОРТ'), '', frmHandle);      // собственный_транспорт
    //название автопредприятия
    Form_Write(WriteAttr(coTTNDoc,TTNDoc.NRec,'НАИМЕНОВАНИЕ АВТОПРЕДПРИЯТИЯ'), '', frmHandle); //Автопредприятие_назв
    //способ погрузки
    if GetFirst MetLoad where ((TTNDoc.cPunPMet == MetLoad.nRec)) = tsOk                     // ТТН_ПунктП_Метод_2
      Form_Write(METLOAD.NAME, '', frmHandle)
    else
      Form_SkipFormat(1, frmHandle);
    //автомобиль (гос.номер + марка)
    if GetFirst Transp where ((TTNDoc.cTransp == Transp.NRec)) = tsOk
    {
      s1 := Transp.Nomer;
      if GetFirst Marka where ((Transp.cMarka == Marka.NRec)) = tsOk
        s1 := s1 + ' ' + Marka.NM
      else
        s1 := s1 + ' ' + Transp.Marka;
    }
    else
      s1 := WriteAttr(coTTNDoc, TTNDoc.NRec, 'АВТОМОБИЛЬ');

    Form_Write(s1, '', frmHandle);                                                           // автомобиль

    //способ транспортировки
    Form_Write(WriteAttr(coTTNDoc, TTNDoc.NRec, 'СПОСОБ ТРАНСПОРТИРОВКИ'), '', frmHandle);   // способ_транспортировки

    //кол-во ездок, заездов
    var KolEzd: word;
    KolEzd := Word(WriteAttrDouble(coTTNDoc, TTNDoc.NRec, 'КОЛИЧЕСТВО ЕЗДОК'));
    Form_Write(if (KolEzd < 1, 1, KolEzd), '', frmHandle);   // кол-во ездок
  }
  else
  {
    Form_SkipFormat(15, frmHandle);
    Form_Write(double(1), '', frmHandle);
  }

  WriteClassNode (coKatSopr, 2, KatSopr.NRec, 'ТРАНСПОРТНЫЕ УСЛУГИ');                        // транспортная_услуга

!-----------------------------------------------------------------------------------------------------------------
  //ссылка на валюту документа
  Form_Write(KatSopr.cVal, '', frmHandle);                                                   //Валюта_нрек
!-----------------------------------------------------------------------------------------------------------------
  // В Ы В О Д   С П Е Ц Ф И К А Ц И И
!-----------------------------------------------------------------------------------------------------------------
  PushPos(#SpSopr);

  ANam     := 0; AkolF    := 0; AKolU    := 0;  AkolV   := 0;
  AStNak   := 0; AStNac   := 0; AStVal   := 0;  ASumOpl := 0;
  aNds     := 0; aNDSv    := 0; aSpN     := 0;  aSpNv   := 0;
  aNSel    := 0; aNSelV   := 0;
  AStNakBN := 0; AStNacBN := 0; AStValBN := 0;  AKolM   := 0;
  AStNakSN := 0; AStNacSN := 0; AStValSN := 0;  

  //визуализация вызывается дважды, если нет ордеров...(из StepMCInfo в prnrasmc.vpp)
  var countVisual: word;
  countVisual := if(ResOrder,1,2) * Kol_SpSopr;

  StartNewVisual(vtIndicatorVisual, vfTimer+vfBreak+vfConfirm, ''#3'Печать спецификации накладной ' +
                                                               PrintNumber(KatSopr.Descr,KatSopr.NSopr), countVisual);

  if(TypeSopr = 632)
  {
    PushBounds(tbSpSopr632Only);
  }
  else
  {
    if (isUsl)
    {
      PushBounds(tbSpSoprAll)
    }
    else
    {
      PushBounds(tbSpSoprMcOnly);
    }
  }


  if (GetFirst SpSopr <> tsOK)
  {
    Form_SkipFormat(194 + 102, frmHandle);

    if (isDEI)
      Form_SkipFormat(4, frmHandle);
  }
  else
  {
!-----------------------------------------------------------------------------------------------------------------
  // В Ы В О Д   Т О В А Р Н Ы Х   П О З И Ц И Й
!-----------------------------------------------------------------------------------------------------------------
    _LOOP SpSopr
    {
      if MyDef.doc201byte1
        if not bPrint.retGroup(n1, n2, ___kol, ___Summa,___NDS, ___AllSumma, SpSopr.nrec)
          continue;

      bIsOnePatry := False;

      if (NOT MyDef.RzNakl)
        if (SpSopr.cOwner <> 0) AND (SpSopr.cParty <> 0)
          if (GetFirst SpSoprF where (( SpSopr.cOwner == SpSoprF.NRec )) = tsOk)
            if (SpSoprF.cParty = SpSopr.cParty)
              bIsOnePatry := True;

      // для стандартных расходных накладных поддерживается печать с внешним расчетом полей
      // ее эффективно использовать на больших спецификациях
      if (isFastReport)
      {
        ANam := ANam + 1;
        Form_Write(SpSopr.nRec, '', frmHandle);                                              // спецификацияМЦ_нрек
        Form_Write(SpSopr.PrMc, '', frmHandle);                                              // Признак_МЦ
        Form_SkipFormat(5, frmHandle);

        if (isDEI)
          Form_SkipFormat(1, frmHandle);

        Form_SkipFormat(17, frmHandle);

        if (NOT bIsOnePatry)
        {
          Form_Write(SpSoprProcNac, '', frmHandle);                                            // Скидка_Надбавка_cтрока
          Form_Write(oFPrice.GetNDEFactoryPrice (SpSopr.NRec, FALSE), '', frmHandle);          // Завод_Цена
          Form_Write(oFPrice.GetFactoryPrice (SpSopr.NRec, CursV, FALSE), '', frmHandle);      // Завод_ЦенаНак
          Form_Write(oFPrice.GetValFactoryPrice (SpSopr.NRec, CursV, FALSE), '', frmHandle);   // Завод_ЦенаВал
          Form_Write(oFPrice.GetNDEFactoryPrice (SpSopr.NRec, TRUE), '', frmHandle);           // Завод_Цена
          Form_Write(oFPrice.GetFactoryPrice (SpSopr.NRec, CursV, TRUE), '', frmHandle);       // Завод_ЦенаНак
          Form_Write(oFPrice.GetValFactoryPrice (SpSopr.NRec, CursV, TRUE), '', frmHandle);    // Завод_ЦенаВал
        }
        else
          Form_SkipFormat(7, frmHandle);

        if (isDEI)
          Form_SkipFormat(3, frmHandle);

        Form_SkipFormat(163+102, frmHandle);

        if (not NextVisual)
        {
          StopVisual('',0);
          if (not ResOrder)
          DoneMCInfo;
          PopPos(#SpSopr);
          StopVisual('',0);
          Form_PutEvent(feBreak, frmHandle);
          Form_AbortForm(frmHandle);
          EXIT;
        }
      }
      else
        if (not PrintMC)
        {
          StopVisual('',0);
          if (not ResOrder)
          DoneMCInfo;
          PopPos(#SpSopr);
          StopVisual('',0);
          Form_PutEvent(feBreak, frmHandle);
          Form_AbortForm(frmHandle);
          EXIT;
        }
!-----------------------------------------------------------------------------------------------------------------
      if MyDef._RETTARA_
        if (GetFirst SpOtpEd where ((SpStep.cOtpEd == SpOtpEd.cOtpEd)) = tsOk)
          case BaseDoc.TaraVoz of
            1: TaraVoz:= 'Тара возвратная';
            2: TaraVoz:= 'Тара невозвратная';
          end;
    }//_Loop

    DoneMarker(FixGroupMC.AllowedDepGroupList, 'getgrfmc_mark');

    if MyDef.doc201byte1
      if NullVipRef (bPrint)
        FreeVIPInterface (bPrint);
  }
  oValFunc.DoneVal;
  Form_PutEvent(feBreak, frmHandle);

  Form_Write(DoubleToString(KatSopr.cVal,Round(AStNakSN,Cena_Pr)), '', frmHandle);
!-----------------------------------------------------------------------------------------------------------------
  // В Ы В О Д   У С Л У Г
!-----------------------------------------------------------------------------------------------------------------
  _LOOP SpSopr where ((KatSopr.Nrec == SpSopr.cSopr AND word(1) << SpSopr.PrMC))
     PrintUsl;

  StopVisual('',0);
  if (not ResOrder)
    DoneMCInfo;

!-----------------------------------------------------------------------------------------------------------------
  // И Т О Г О В Ы Е   С У М М Ы
!-----------------------------------------------------------------------------------------------------------------
  Form_Write(TaraVoz, '', frmHandle);

  if MyDef.doc201byte1
    Form_Write(___AllSumma, Cena_PrR, frmHandle);
  else
    Form_Write(ANam, '', frmHandle);

  Form_Write(DoubleToStr(ANam, '4'), '', frmHandle);
  Form_Write(AKolF,Kol_Pr, frmHandle);
  Form_Write(DoubletoStr(AKolF,'45'), '', frmHandle);
  Form_Write(AKolU,Kol_Pr, frmHandle);
  Form_Write(DoubletoStr(AKolU,'45'), '', frmHandle);
  Form_Write(AKolM,Kol_Pr, frmHandle);
  Form_Write(DoubletoStr(AKolM,'45'), '', frmHandle);
  Form_Write(AKolV,Kol_Pr, frmHandle);
  Form_Write(DoubletoStr(AKolV,'45'), '', frmHandle);
  Form_Write(Round(AStNak,Cena_Pr),Cena_Pr, frmHandle);
  Form_Write(DoubleToString(KatSopr.cVal,Round(AStNak,Cena_Pr)), '', frmHandle);
  Form_Write(Round(ASumOpl,Cena_Pr),Cena_Pr, frmHandle);
  Form_Write(DoubleToString(KatSopr.cVal,Round(ASumOpl,Cena_Pr)), '', frmHandle);

  Form_Write(Round(AStNac,Cena_PrR),Cena_PrR, frmHandle);
  Form_Write(DoubleToString(0,Round(AStNac,Cena_PrR)), '', frmHandle);
  Form_Write(Round(AStNac+TTNDoc.SumAvt,Cena_PrR),Cena_PrR, frmHandle);
  Form_Write(DoubleToString(0,Round(AStNac+TTNDoc.SumAvt,Cena_PrR)), '', frmHandle);
  Form_Write(Round(AStVal,Cena_PrV),Cena_PrV, frmHandle);
  Form_Write(DoubleToString(SpSopr.cVal,Round(AStVal,Cena_PrV)), '', frmHandle);
  Form_Write(Round(AStNakBN,Cena_Pr),Cena_Pr, frmHandle);
  Form_Write(DoubleToString(KatSopr.cVal,Round(AStNakBN,Cena_Pr)), '', frmHandle);
  Form_Write(Round(AStNacBN,Cena_PrR),Cena_PrR, frmHandle);
  Form_Write(DoubleToString(0,Round(AStNacBN,Cena_PrR)), '', frmHandle);
  Form_Write(Round(AStValBN,Cena_PrV),Cena_PrV, frmHandle);
  Form_Write(DoubleToString(SpSopr.cVal,Round(AStValBN,Cena_PrV)), '', frmHandle);
  Form_Write(Round(AStNakSN,Cena_Pr),Cena_Pr, frmHandle);
  Form_Write(DoubleToString(KatSopr.cVal,Round(AStNakSN,Cena_Pr)), '', frmHandle);
  Form_Write(Round(AStNacSN,Cena_PrR),Cena_PrR, frmHandle);
  Form_Write(DoubleToString(0,Round(AStNacSN,Cena_PrR)), '', frmHandle);
  Form_Write(Round(AStValSN,Cena_PrV),Cena_PrV, frmHandle);
  Form_Write(DoubleToString(SpSopr.cVal,Round(AStValSN,Cena_PrV)), '', frmHandle);

  if (KatSopr.cVal = 0)
  {
    Form_Write(Round(aNDS,Cena_PrR),Cena_PrR, frmHandle);
    Form_Write(DoubleToString(0,Round(aNDS,Cena_PrR)), '', frmHandle);
    Form_Write(Round(aSpN,Cena_PrR),Cena_PrR, frmHandle);
    Form_Write(DoubleToString(0,Round(aSpN,Cena_PrR)), '', frmHandle);
    Form_Write(Round(aNSel,Cena_PrR),Cena_PrR, frmHandle);
    Form_Write(DoubleToString(0,Round(aNSel,Cena_PrR)), '', frmHandle);
    Form_Write(Round(aSpN+aNDS+aNSel,Cena_PrR),Cena_PrR, frmHandle);
    Form_Write(DoubleToString(0,Round(aSpN+aNDS+aNSel,Cena_PrR)), '', frmHandle);
  }
  else
  {
    Form_Write(Round(aNDSv,Cena_PrV),Cena_PrV, frmHandle);
    Form_Write(DoubleToString(SpSopr.cVal,Round(aNDSv,Cena_PrV)), '', frmHandle);
    Form_Write(Round(aSpNv,Cena_PrV),Cena_PrV, frmHandle);
    Form_Write(DoubleToString(SpSopr.cVal,Round(aSpNv,Cena_PrV)), '', frmHandle);
    Form_Write(Round(aNSelV,Cena_PrV),Cena_PrV, frmHandle);
    Form_Write(DoubleToString(SpSopr.cVal,Round(aNSelV,Cena_PrV)), '', frmHandle);
    Form_Write(Round(aSpNv+aNDSv+aNSelV,Cena_PrV),Cena_PrV, frmHandle);
    Form_Write(DoubleToString(SpSopr.cVal,Round(aSpNv+aNDSv+aNSelV,Cena_PrV)), '', frmHandle);
  }

  Form_Write(Round(aNDS,Cena_PrR),Cena_PrR, frmHandle);
  Form_Write(DoubleToString(0,Round(aNDS,Cena_PrR)), '', frmHandle);
  Form_Write(Round(aSpN,Cena_PrR),Cena_PrR, frmHandle);
  Form_Write(DoubleToString(0,Round(aSpN,Cena_PrR)), '', frmHandle);
  Form_Write(Round(aNSel,Cena_PrR),Cena_PrR, frmHandle);
  Form_Write(DoubleToString(0,Round(aNSel,Cena_PrR)), '', frmHandle);
  Form_Write(Round(aSpN+aNDS+aNSel,Cena_Pr),Cena_PrR, frmHandle);
  Form_Write(DoubleToString(0,Round(aSpN+aNDS+aNSel,Cena_PrR)), '', frmHandle);
  Form_Write(Round(aNDSv,Cena_PrV),Cena_PrV, frmHandle);
  Form_Write(DoubleToString(SpSopr.cVal,Round(aNDSv,Cena_PrV)), '', frmHandle);
  Form_Write(Round(aSpNv,Cena_PrV),Cena_PrV, frmHandle);
  Form_Write(DoubleToString(SpSopr.cVal,Round(aSpNv,Cena_PrV)), '', frmHandle);
  Form_Write(Round(aNSelv,Cena_PrV),Cena_PrV, frmHandle);
  Form_Write(DoubleToString(SpSopr.cVal,Round(aNSelv,Cena_PrV)), '', frmHandle);
  Form_Write(Round(aSpNv+aNDSv+aNSelV,Cena_PrV),Cena_PrV, frmHandle);
  Form_Write(DoubleToString(SpSopr.cVal,Round(aSpNv+aNDSv+aNSelV,Cena_PrV)), '', frmHandle);

  if (KatSopr.cVal <> 0)
  {
    aNDS := aNDSv;
    aSpN := aSpNv;
    aNSel := aNSelV;
  }
  if (aStNakSN <> 0)
  {
    Form_Write(aNDS / aStNakBN * 100,Cena_Pr, frmHandle);
    Form_Write(aSpN / aStNakBN * 100,Cena_Pr, frmHandle);
    Form_Write(aNSel / aStNakBN * 100,Cena_Pr, frmHandle);
    Form_Write((aSpN+aNDS+aNSel) / aStNakBN * 100,Cena_Pr, frmHandle);
  }
  else
    WriteNullCount(4);

  // подписанты
  Form_SkipFormat(10, frmHandle);

  for (i := 1; i <= 5; i++)
    Form_Write(sAllDocs[i], '', frmHandle); // все_документы

  for (i := 1; i <= 5; i++)
    Form_Write(sCerts[i], '', frmHandle);   // все_сертификаты

  Form_Write(sPrice, '', frmHandle);        // все_прайслисты
!-----------------------------------------------------------------------------------------------------------------
  // Д О П О Л Н И Т Е Л Ь Н Ы Й   Ц И К Л   П О   Т О В А Р Н Ы М   П О З И Ц И Я М
!-----------------------------------------------------------------------------------------------------------------
  If getfirst SpSopr where ((KatSopr.Nrec == SpSopr.cSopr AND
                             word(1) == SpSopr.PrMC)) <> tsOK
    Form_SkipFormat(47, frmHandle);
  else
    _Loop SpSopr where ((KatSopr.NRec             == SpSopr.cSopr AND
                         if(TypeSopr = 632, 0, 1) == SpSopr.PrMC     ))
    {
      Form_Write(SpSopr.nRec, '', frmHandle);                                            // спецификация2_нрек

      if (isDEI)
        if (isValid(#AllMemo))
          Form_Write(AllMemo.Mem, '', frmHandle)
         else
          Form_SkipFormat(1, frmHandle);

      Form_Write(KatMC.Name, '', frmHandle);// Название
      Form_Write(KatMC.BarKod, '', frmHandle);                                           // КодМЦ2
      Form_Write(SpSopr.KolFact2, '', frmHandle);                                        // Объем2
      Form_Write(SpSopr.OilPlot, '', frmHandle);                                         // Плотность2
      Form_Write(SpSopr.KolFact,Kol_Pr, frmHandle);                                      // КолФ2


      Form_Write(WriteAttrDouble(coSpSopr,SpSopr.nRec,'БРАК'), '', frmHandle);           // Брак2
      Form_Write(WriteAttrDouble(coSpSopr,SpSopr.nRec,'БОЙ') , '', frmHandle);           // Бой2

      Form_Write(Round(SpSopr.rPrice,Cena_PrR),Cena_PrR, frmHandle);                     // ЦНац2

      var StNac, StNacOpl: double;
      StNac    := SpSopr.Price * SpSopr.KolFact;
      StNacOpl := SpSopr.Price * SpSopr.KolOpl;

      if (GetFirst Nalogi where ((SpSopr.nRec  == Nalogi.cSpSopr)) = tsOK)
      {
        //  НДС
        Form_Write(Nalogi.sNDS , Cena_PrR, frmHandle);                                     // ЦНДСНац2
        Form_Write(Nalogi.sNDSv, Cena_PrV, frmHandle);                                     // ЦНДСВал2
        Form_Write(Nalogi.PrNDS, '', frmHandle);                                           // ПрНДС2
        //  акциз
        Form_Write(Nalogi.sSpN , Cena_PrR, frmHandle);                                     // ЦАкцизНац2
        Form_Write(Nalogi.sSpNV, Cena_PrV, frmHandle);                                     // ЦАкцизВал2
        Form_Write(Nalogi.PrSpN, '', frmHandle);                                           // ПрАкциз2
        //  налог с продаж
        Form_Write(Nalogi.sNSel , Cena_PrR, frmHandle);                                    // ЦНПродНац2
        Form_Write(Nalogi.sNSelV, Cena_PrV, frmHandle);                                    // ЦНПродВал2
        Form_Write(Nalogi.PrNSel , '', frmHandle);                                         // ПрНПрод2
      }
      else
        Form_SkipFormat(9, frmHandle);

      Form_Write(StNac, Cena_PrR, frmHandle);                                            // СтНац2
      Form_Write(StNacOpl , Cena_PrR, frmHandle);                                        // СтНацОпл2

      if (KatSopr.VhodNal = 1)
      {
        Form_Write(StNac     - SpSopr.SumNDS, Cena_PrR, frmHandle);                      // СтНацБН2
        Form_Write(StNacOpl  - SpSopr.SumNDS, Cena_PrR, frmHandle);                      // СтНацБНОпл2
        Form_Write(StNac                    , Cena_PrR, frmHandle);                      // СтНацCН2
        Form_Write(StNacOpl                 , Cena_PrR, frmHandle);                      // СтНацCНОпл2
      }
      else
      {
        Form_Write(StNac                    , Cena_PrR, frmHandle);                      // СтНацБН2
        Form_Write(StNacOpl                 , Cena_PrR, frmHandle);                      // СтНацБНОпл2
        Form_Write(StNac     + SpSopr.SumNDS, Cena_PrR, frmHandle);                      // СтНацБН2
        Form_Write(StNacOpl  + SpSopr.SumNDS, Cena_PrR, frmHandle);                      // СтНацБНОпл2
      }

      Form_Write(SpSopr.SumNDS,Cena_PrR, frmHandle);                                     // СтНалНац2

      case KatSopr.VidSopr of
      521,522,523,106,206,632:
      {
        Form_Write(KatMc.Massa, '', frmHandle);                                              // МассаМЦ2
        Form_Write(KatMc.MTara, '', frmHandle);                                              // МассаТарыМЦ2
      }
      else
      {
        Form_Write(SpSopr.Netto, '', frmHandle);                                             // МассаМЦ2
        Form_Write(SpSopr.MTara, '', frmHandle);                                             // МассаТарыМЦ2
      }
      end;
      KoefP := fEdIzm.GetKoefOtpEd(SpSopr.cOtpEd);
      Form_Write(SpSopr.KolFact * KoefP, Kol_Pr, frmHandle);                                 // КолУч2
      Form_Write(SpSopr.KolOpl, Kol_Pr, frmHandle);                                          // КолОпл2
      Form_Write(KatOtpEd.Name, '', frmHandle);                                              // ОтпЕдАббр2
      Form_Write(TTNMetMassa.Name, '', frmHandle);                                           // СпособОпрВеса2

      if (isAlc) and (SpSopr.cParty<>0)
      {                                                                                      // Номер_сертификата2
        Form_Write(KatParty.NSertif, '', frmHandle);                                         // Дата_сертификата2
        Form_Write(KatParty.dSertif, '', frmHandle);                                         // Ктовыдал_сертификат2
        Form_Write(KatParty.WhoSertif, '', frmHandle);                                       // удост_госгигиен_регистрации2
        WriteDopClassInfo('УДОСТОВЕРЕНИЕ О ГОС.ГИГИЕН.РЕГИСТРАЦИИ');                         // таможенные_разрешения2
        WriteDopClassInfo('ТАМОЖЕННЫЕ РАЗРЕШЕНИЯ');                                          // акцизные_марки_узел
        WriteDopClassInfo('АКЦИЗНЫЕ МАРКИ');
//акцизные_марки1 акцизные_марки2 акцизные_марки3 акцизные_марки4 акцизные_марки5
//акцизные_марки6 акцизные_марки7 акцизные_марки8 акцизные_марки9 акцизные_марки10
        WriteClassNode (coKatParty, 10, KatParty.NRec, 'АКЦИЗНЫЕ МАРКИ');
      }
      else
        Form_SkipFormat(16, frmHandle);

      if (isDEI)
        _LOOP SpDopEd
        {
          Form_PutEventById(feDoLoop, fcTOVN_DEI2, frmHandle);
          Form_Write(KatDopEd.Name, '', frmHandle);
          Form_Write(SpDopEd.Kol  , Kol_Pr, frmHandle);
          Form_Write(if (KatSopr.cVal = 0, (SpSopr.Price  * SpSopr.KolFact) / SpDopEd.Kol ,
                                           (SpSopr.VPrice * SpSopr.KolFact) / SpDopEd.Kol), Cena_PrR, frmHandle);
        }
    }

  Form_PutEvent(feBreak, frmHandle);
!-----------------------------------------------------------------------------------------------------------------

  if (pg_flag <> 0 ) and (iNakl < MarkerCount-1)
    Form_Write('  ', '', frmHandle);                                                        // СпецСимвол
  else
    Form_SkipFormat(1, frmHandle);

  PopPos(#SpSopr);

  if (not NextVisual)
    {
      StopVisual('',0);
      Form_AbortForm(frmHandle);
      Exit;
    }

} //***FOR

  Form_PutEvent(feBreak, frmHandle);

  if (VisStarted)
    StopVisual('',0);

  VisStarted := false;

  // при wParam = 4 форма на экран не выводится
  if (((wParam AND 4) <> 4))
    if (Form_Error(frmHandle))
      Form_AbortForm(frmHandle)
    else
    {
      Form_ShowFile(KatDoc.Name, false, frmHandle);
      if (KatSopr.vidSopr = 600) AND ExistTune('Sklad.Akt_Move.AfterPrint')
        if (coGetTune('Sklad.Akt_Move.AfterPrint') <> 0)
          if RunInterface('SimpleWayToRunAlgorithm', coGetTune('Sklad.Akt_Move.AfterPrint'),
                           word(2600), KatSopr.NRec, comp(0)) <> cmCancel {};

      if (KatSopr.vidSopr = 201) AND ExistTune('Oper.Sell.Nakl.AfterPrint')
        if (coGetTune('Oper.Sell.Nakl.AfterPrint') <> 0)
          if RunInterface('SimpleWayToRunAlgorithm', coGetTune('Oper.Sell.Nakl.AfterPrint'),
                           word(2201), KatSopr.NRec, comp(0)) <> cmCancel {};
    }
} // End PrinDocument
